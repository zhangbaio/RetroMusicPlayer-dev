# RetroMusic 已实现功能需求文档（基于当前代码）

## 1. 文档说明
- 文档目标：将当前项目“已经实现并可追溯到代码”的能力整理为需求文档，作为后续迭代基线。
- 文档范围：Android 客户端（本仓库 `app` 与 `appthemehelper` 模块）。
- 基线版本：以当前工作区代码为准。

## 2. 产品目标
- 统一管理本地音乐与 WebDAV 音乐。
- 提供稳定的播放、列表管理、歌词/封面展示与主题个性化能力。
- 在 WebDAV 大目录场景下兼顾同步正确性与性能。

## 3. 角色与场景
- 普通用户：本地听歌、管理歌单、收藏、搜索。
- 云音乐用户：配置 WebDAV、选择目录、增量同步、下载到本地。
- 高阶用户：自定义 Database 页面内容顺序、主题与播放页视觉策略。

## 4. 信息架构与导航需求

### FR-IA-001 底部主导航
- 系统应提供 5 个主 Tab：`Home`、`Songs`（本地）、`Web`（WebDAV）、`Database`、`Search`。
- 主导航切换应使用根路由跳转，不保留跨 Tab 的错误堆栈状态。

### FR-IA-002 Database Tab 回根策略
- 用户点击或重复点击 `Database` Tab 时，应始终回到 Database 首页，不应停留在其子页（如 Songs/Artists 详情）。

### FR-IA-003 细分页面底部导航可见性
- `albumDetailsFragment`、`artistDetailsFragment`、`playlistDetailsFragment` 等页面应保持底部导航可见。

## 5. Database 页面需求

### FR-DB-001 合并入口
- Database 页面应聚合以下四类入口：`Playlists`、`Artists`、`Albums`、`Songs`。

### FR-DB-002 编辑弹窗能力
- 编辑弹窗可配置项必须仅包含：`albums`、`artists`、`playlists`、`songs`。
- 支持显示/隐藏与拖拽排序。
- 点击 `Done` 后应立即生效并刷新 Database 首页。
- 至少保留一个可见项。

### FR-DB-003 Songs 跳转行为
- Database 页面点击 `Songs` 时应进入 Songs 主 Tab（本地歌曲视图）。

## 6. Search Tab 需求

### FR-SR-001 搜索入口
- Search Tab 顶部应提供进入搜索页的入口（点击后跳转搜索页面）。

### FR-SR-002 网格内容
- Search Tab 主体网格应展示 Playlists 列表（2 列）。
- 无数据时显示空状态而非空白页。

## 7. Songs 与 Web 页面需求

### FR-SW-001 数据源隔离
- `Songs` 页面仅展示 `LOCAL` 来源歌曲。
- `Web` 页面仅展示 `WEBDAV` 来源歌曲。

### FR-SW-002 统一列表能力
- 两页面均支持排序、布局切换、网格列数调整、随机播放。

### FR-SW-003 空状态优化
- 无歌曲时显示统一的图标 + 标题 + 描述空状态，区分本地与 WebDAV 文案。

## 8. 播放与队列需求

### FR-PL-001 播放页信息展示
- 歌曲标题、歌手信息应使用可用值显示；未知歌手不显示 `unknown artist` 字样，显示为空。

### FR-PL-002 播放页交互
- 支持收藏、更多菜单、上一首/下一首、播放/暂停、歌词模式、队列模式、投射入口。
- 歌手文字可点击跳转歌手页（有歌手信息时）。

### FR-PL-003 歌词与队列切换
- 播放页歌词/队列切换应使用平滑过渡动画，避免突兀跳变。
- 队列展开时不应改变进度条与主控制区的稳定位置。

### FR-PL-004 播放进度持久化
- 应周期性保存播放进度（当前队列位置 + 曲内进度）。
- 重启应用后可恢复队列和曲内进度继续播放。

## 9. 播放队列与歌单管理需求

### FR-LS-001 列表删除稳定性
- 删除歌曲（含 WebDAV 歌曲）应支持从数据库与播放队列正确移除。
- 删除确认弹窗文案需按单曲/多曲场景正确展示。

### FR-LS-002 收藏与歌单一致性
- 收藏夹、播放列表页面删除歌曲后，列表应即时反映，不保留脏项。

## 10. WebDAV 配置管理需求

### FR-WC-001 配置 CRUD
- 支持新增/编辑/删除 WebDAV 配置：名称、URL、用户名、密码、音乐目录列表、启用状态、最后同步时间。

### FR-WC-002 密码安全与编辑回填
- 密码应以加密形式持久化。
- 编辑弹窗应可正确解密回填密码；若解密失败应要求用户重输，不得保留 `encrypted://...` 伪值用于连接。

### FR-WC-003 目录选择能力
- 支持手动输入目录、浏览目录、编辑已选目录、删除已选目录。
- 目录路径应规范化（含前导 `/`，去尾部 `/`）。

### FR-WC-004 连接测试
- 支持在配置页与弹窗内发起连接测试并反馈成功/失败。

## 11. WebDAV 同步核心需求

### FR-WS-001 同步模式
- 支持完整同步与失败目录重试同步（retry-failed-only）。
- 同步任务使用 WorkManager 运行，支持前台通知与后台继续执行。

### FR-WS-002 同步进度可视化
- 同步期间应持续上报：已完成目录数、总目录数、当前目录、本目录同步歌曲数、是否失败。
- 设置页应展示同步中状态与目录级进度文案。

### FR-WS-003 目录增量策略
- 对“新勾选目录”进行增量扫描。
- 对“取消勾选目录”执行本地歌曲删除。
- 对“云端已删除文件”执行本地歌曲删除。

### FR-WS-004 同步恢复与可靠性
- 支持目录级 checkpoint，异常后可从已完成目录集合恢复。
- 记录失败目录队列，后续自动或手动重试。

### FR-WS-005 扫描性能优化
- 目录扫描支持自适应并发（含超时降并发、稳定后升并发）。
- 并发扫描失败时可回退串行扫描，保证可用性。
- 支持目录 quick signature 快速跳过未变更目录。
- 支持目录 summary hash 跳过未变化内容，减少重复写库。

### FR-WS-006 去重策略
- WebDAV 同步需过滤重复歌曲。
- 重复判定基于标准化键（标题/歌手，必要时回退路径语义）。
- 冲突保留规则：优先保留文件更大的歌曲；同大小时保留更新时间更近者；再同值按稳定路径规则。

### FR-WS-007 同步后处理
- 同步成功后写回 `lastSynced`。
- 更新已同步目录集合、目录签名、目录摘要缓存。
- 对缺失时长歌曲启动分批回填任务（受文件数量和总字节预算约束）。

## 12. WebDAV 元数据、歌词、封面与播放需求

### FR-WM-001 歌手/标题自动推断
- 需支持从文件名解析歌手与标题：
  - `歌手-歌名`、`歌名-歌手` 等双段格式；
  - 结合同目录命名模式投票；
  - 结合 token 频次推断；
  - 回退父目录/祖父目录作为歌手候选。
- 对通用目录名（music、download、artist 等）应过滤，避免误识别。

### FR-WM-002 多音频格式支持
- WebDAV 音频扫描至少支持：`mp3`、`flac`、`m4a`、`ogg`、`wav`、`aac`、`opus`、`wma`、`m4b`、`mp4a`。

### FR-WM-003 歌词链路
- 对 WebDAV 歌曲加载歌词时，应按优先级：
  1) 本地缓存 lrc；
  2) 远端同名侧车歌词（`.lrc/.txt`）与常见 `lyrics.*`；
  3) 下载音频临时文件提取内嵌歌词。
- 解析成功后写本地缓存，供后续快速读取。

### FR-WM-004 封面链路
- WebDAV 歌曲封面优先使用目录封面（`cover/album/folder` 的 `jpg/png/webp`）。
- 播放与列表封面加载需支持鉴权访问与重定向。

### FR-WM-005 WebDAV 播放兼容
- WebDAV 歌曲在 Songs/Web/Favorites/Playlist 等入口均应可正常播放。
- 数据源需支持 Basic Auth、重定向及网络重试（含 429 限流退避）。

## 13. WebDAV 歌曲下载需求

### FR-WD-001 列表下载入口
- WebDAV 歌曲菜单应提供“下载到设备”动作。

### FR-WD-002 下载能力
- 支持鉴权下载、最多多次重定向跟随、文件名冲突重命名。
- Android Q+ 使用 MediaStore 写入 `Music/RetroMusic/WebDAV`。
- 下载完成后应被系统媒体库识别。

## 14. 本地媒体初始化与周期校验需求

### FR-MT-001 首次安装本地重建
- 应以安装时间为标记执行一次本地媒体重建扫描。
- 扫描期间可临时隐藏本地歌曲结果，扫描完成后触发 Songs/Albums/Artists/Home/Suggestions 刷新。

### FR-MT-002 WebDAV 周期校验
- 应每 24 小时触发一次已启用 WebDAV 配置的同步校验任务。

## 15. 主题与视觉需求

### FR-TH-001 全局主题基线
- 主题色语义应以 Apple Music 风格为主（强调色、浅色/深色表面色、分割线语义）。
- 默认 accent 使用 Apple Music 红（`#FC3C44`）。

### FR-TH-002 播放页视觉策略
- 播放页前景控件（标题、歌手、收藏、更多、进度、播放控制、歌词/投射/列表等）统一白色风格。
- 背景支持基于封面主色的自适应渐变（顶部到底部连续变化）。

### FR-TH-003 Accent 可配置
- 设置页保留 Accent 选择器，支持白色分组选择（含浅白阶）。

## 16. 数据一致性与清理需求

### FR-DC-001 配置删除联动
- 删除 WebDAV 配置时，必须删除该配置关联歌曲与同步缓存状态（已同步目录、签名、失败队列、checkpoint）。

### FR-DC-002 脏数据治理
- 本地歌曲清理逻辑不得误删 WebDAV 歌曲。
- WebDAV 同步应持续清理因目录取消、远端删除、去重判定导致的本地脏数据。

## 17. 非功能需求

### NFR-001 性能
- 大目录扫描场景需控制网络超时影响，支持并发自适应与快速跳过。
- 同步过程避免全量重建，优先增量更新。

### NFR-002 可靠性
- 任务异常应可恢复（checkpoint + failed queue）。
- 同步失败需给出明确错误信息，不允许静默失败。

### NFR-003 可观测性
- 同步应提供日志关键指标：新增、跳过、远端删除、去重删除、失败目录等。
- UI 与通知应提供可感知进度反馈。

## 18. 验收清单（建议）
- AC-001：`Songs` 仅本地、`Web` 仅 WebDAV，互不串源。
- AC-002：Database 编辑仅四项，拖拽后点击 `Done` 立即生效。
- AC-003：编辑 WebDAV 配置后密码不会回写为 `encrypted://...` 导致连接失败。
- AC-004：勾选目录新增时仅增量同步新增目录；取消目录后本地对应歌曲被删除。
- AC-005：WebDAV 同步中途退到其他页面，任务继续执行且可回到设置页查看进度。
- AC-006：存在同名/同艺人重复音频时，仅保留最大文件。
- AC-007：WebDAV 歌曲可在收藏夹/歌单/列表正常播放。
- AC-008：播放页切歌词/队列动画平滑，进度条与主控制区位置稳定。
- AC-009：重启应用后恢复播放队列与曲内进度。
- AC-010：下载 WebDAV 歌曲可成功落盘并在系统媒体库可见。

## 19. 后续扩展建议（非当前已实现）
- 增加“仅 Wi-Fi 同步”“充电中同步”等策略开关。
- 提供每个 WebDAV 配置的同步统计面板（耗时、速率、失败目录详情）。
- 提供去重规则可配置项（按大小优先/按码率优先/按时间优先）。
